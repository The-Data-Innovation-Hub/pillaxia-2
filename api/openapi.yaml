openapi: 3.0.3
info:
  title: Pillaxia API
  description: |
    REST API for the Pillaxia medication management platform.
    Provides PostgREST-compatible endpoints for database access,
    RPC endpoints for complex operations, and storage endpoints
    for file management via Azure Blob Storage.
  version: 1.0.0
  contact:
    name: Pillaxia Team

servers:
  - url: https://pillaxia-dev-api.azurewebsites.net
    description: Development
  - url: http://localhost:3000
    description: Local development

security:
  - bearerAuth: []

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Azure AD B2C JWT token

  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
        details:
          type: array
          items:
            type: string

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ok, unhealthy]
        timestamp:
          type: string
          format: date-time
        db:
          type: object
          properties:
            status:
              type: string
              enum: [connected, disconnected]
            latencyMs:
              type: number
        pool:
          type: object
          properties:
            total:
              type: integer
            idle:
              type: integer
            waiting:
              type: integer

    Profile:
      type: object
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        first_name:
          type: string
        last_name:
          type: string
        phone:
          type: string
        language_preference:
          type: string
          enum: [en, fr, ha, ig, yo]
        avatar_url:
          type: string
        organization_id:
          type: string
          format: uuid
        is_active:
          type: boolean

    Medication:
      type: object
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        name:
          type: string
        dosage:
          type: string
        frequency:
          type: string
        is_active:
          type: boolean
        start_date:
          type: string
          format: date
        end_date:
          type: string
          format: date
        expiry_date:
          type: string
          format: date
        remaining_quantity:
          type: integer
        refill_threshold:
          type: integer

paths:
  /health:
    get:
      summary: Health check (readiness)
      description: Returns API health status with DB connectivity and pool stats
      tags: [Health]
      security: []
      responses:
        '200':
          description: API is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '503':
          description: API is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /health/ready:
    get:
      summary: Readiness probe
      description: Full readiness check with DB connectivity
      tags: [Health]
      security: []
      responses:
        '200':
          description: Ready
        '503':
          description: Not ready

  /health/live:
    get:
      summary: Liveness probe
      description: Returns 200 if the process is running
      tags: [Health]
      security: []
      responses:
        '200':
          description: Alive

  /rest/{table}:
    get:
      summary: Query table rows
      description: |
        PostgREST-compatible SELECT with filters, ordering, pagination, and joins.
        Supports `eq.`, `neq.`, `gt.`, `lt.`, `gte.`, `lte.`, `like.`, `ilike.`,
        `in.()`, `is.null`, `not.is.null`, and `.or()` filters.
      tags: [REST]
      parameters:
        - name: table
          in: path
          required: true
          schema:
            type: string
        - name: select
          in: query
          description: Comma-separated columns or `*`. Supports embedded resources via `table(columns)`.
          schema:
            type: string
        - name: order
          in: query
          description: 'Column.direction (e.g., `created_at.desc`)'
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            maximum: 1000
      responses:
        '200':
          description: Array of matching rows
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (unknown table or insufficient permissions)

    post:
      summary: Insert a row
      description: Insert a new row. Body is validated against Zod schema if available.
      tags: [REST]
      parameters:
        - name: table
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '201':
          description: Created row(s)
        '400':
          description: Validation error
        '401':
          description: Unauthorized
        '403':
          description: Forbidden

    patch:
      summary: Update rows
      description: Update rows matching query filters. Body validated with partial Zod schema.
      tags: [REST]
      parameters:
        - name: table
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Updated row(s)
        '400':
          description: Validation error or missing filters
        '401':
          description: Unauthorized

    delete:
      summary: Delete rows
      description: Delete rows matching query filters. Filters are required.
      tags: [REST]
      parameters:
        - name: table
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Deleted
        '400':
          description: Missing filters
        '401':
          description: Unauthorized

  /rpc/upsert_user_from_jwt:
    post:
      summary: Sync user from JWT claims
      tags: [RPC]
      responses:
        '200':
          description: User ID
        '401':
          description: Unauthorized

  /rpc/is_device_trusted:
    post:
      summary: Check if a device is trusted
      tags: [RPC - Security]
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                p_user_id:
                  type: string
                  format: uuid
                p_device_token_hash:
                  type: string
      responses:
        '200':
          description: Boolean trusted status

  /rpc/log_security_event:
    post:
      summary: Log a security event
      tags: [RPC - Security]
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                p_event_type:
                  type: string
                p_event_category:
                  type: string
                p_severity:
                  type: string
                p_description:
                  type: string
                p_ip_address:
                  type: string
                p_user_agent:
                  type: string
                p_metadata:
                  type: object
      responses:
        '200':
          description: Event ID

  /rpc/trust_device:
    post:
      summary: Trust a device for MFA bypass
      tags: [RPC]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_device_token_hash]
              properties:
                p_user_id:
                  type: string
                  format: uuid
                p_device_token_hash:
                  type: string
                  minLength: 1
                  maxLength: 512
                p_device_name:
                  type: string
                  maxLength: 255
                p_browser:
                  type: string
                  maxLength: 255
                p_operating_system:
                  type: string
                  maxLength: 255
                p_ip_address:
                  type: string
                  maxLength: 45
                p_expires_in_days:
                  type: integer
                  minimum: 1
                  maximum: 365
      responses:
        '200':
          description: Device ID
        '400':
          description: Validation failed

  /rpc/revoke_trusted_device:
    post:
      summary: Revoke a single trusted device
      tags: [RPC]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_device_id]
              properties:
                p_device_id:
                  type: string
                  format: uuid
      responses:
        '200':
          description: Success boolean

  /rpc/revoke_all_trusted_devices:
    post:
      summary: Revoke all trusted devices for a user
      tags: [RPC]
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                p_user_id:
                  type: string
                  format: uuid
      responses:
        '200':
          description: Count of revoked devices

  /rpc/log_data_access:
    post:
      summary: Log a data access event for compliance auditing
      tags: [RPC]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_accessed_table, p_access_type]
              properties:
                p_user_id:
                  type: string
                  format: uuid
                p_accessed_table:
                  type: string
                  minLength: 1
                  maxLength: 100
                p_accessed_record_id:
                  type: string
                  format: uuid
                p_access_type:
                  type: string
                  maxLength: 50
                p_data_category:
                  type: string
                  maxLength: 100
                p_patient_id:
                  type: string
                  format: uuid
                p_reason:
                  type: string
                  maxLength: 500
                p_ip_address:
                  type: string
                  maxLength: 45
                p_user_agent:
                  type: string
                  maxLength: 500
      responses:
        '200':
          description: Log ID

  /rpc/record_login_attempt:
    post:
      summary: Record a login attempt for security tracking
      tags: [RPC]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_email, p_success]
              properties:
                p_email:
                  type: string
                  format: email
                  maxLength: 255
                p_user_id:
                  type: string
                  format: uuid
                  nullable: true
                p_ip_address:
                  type: string
                  maxLength: 45
                p_user_agent:
                  type: string
                  maxLength: 500
                p_success:
                  type: boolean
      responses:
        '200':
          description: Result

  /rpc/check_account_locked:
    post:
      summary: Check if an account is locked due to failed login attempts
      tags: [RPC]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_email]
              properties:
                p_email:
                  type: string
                  format: email
                  maxLength: 255
      responses:
        '200':
          description: Lock status result

  /rpc/generate_prescription_number:
    post:
      summary: Generate a unique prescription number
      description: Requires clinician or admin role.
      tags: [RPC]
      responses:
        '200':
          description: Prescription number
        '403':
          description: Insufficient role

  /storage/{bucket}/{path}:
    put:
      summary: Upload a file
      description: |
        Upload a file to Azure Blob Storage. Bucket must be in allowlist
        (avatars, documents, attachments). Path must start with `{userId}/`.
        Content-Type must be in the allowed types list.
      tags: [Storage]
      parameters:
        - name: bucket
          in: path
          required: true
          schema:
            type: string
            enum: [avatars, documents, attachments]
        - name: path
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          image/jpeg:
            schema:
              type: string
              format: binary
          image/png:
            schema:
              type: string
              format: binary
          application/pdf:
            schema:
              type: string
              format: binary
      responses:
        '200':
          description: Upload successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  url:
                    type: string
        '400':
          description: Invalid path or file type
        '403':
          description: Forbidden bucket or ownership check failed

  /storage/{bucket}:
    delete:
      summary: Delete files
      description: Delete one or more files. All paths must be owned by the user.
      tags: [Storage]
      parameters:
        - name: bucket
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [paths]
              properties:
                paths:
                  type: array
                  items:
                    type: string
      responses:
        '204':
          description: Deleted
        '400':
          description: Invalid request
        '403':
          description: Forbidden
